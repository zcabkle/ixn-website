<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Deployment</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"
        type="text/css" />
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"
        rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <style>
        h2 {
            text-align: center;
        }

        p {
            text-align: left;
        }
        .indent-4 {
            margin-left: 5%;
        }
        .indent-8 {
            margin-left: 10%;
        }  
        .indent-12 {
            margin-left: 15%;
        }       
    </style>
    <link rel="shortcut icon" type="image/ico" href="/UCLfavicon.ico" />
</head>

<body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="index.html">IXN Team 19</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto py-4 py-lg-0">
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="requirements.html">Requirements</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="research.html">Research</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="ui-design.html">UI Design</a>
                    </li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="system-design.html">System
                            Design</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="implementation.html">Implementation</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="deployment.html">Deployment</a>
                    </li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="testing.html">Testing</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="evaluation.html">Evaluation</a>
                    </li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="appendix.html">Appendix</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Page Header-->
    <header class="masthead" style="background-image: url('assets/img/gradient.png')">
        <div class="container position-relative px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <div class="page-heading">
                        <h1>Deployment</h1>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content-->
    <main class="mb-4">
        <!-- Start of Deployment-Intro section -->
        <section class="Deployment">
            <div class="container px-4 px-lg-5">
                <div class="row justify-content-center">
                    <div class="col-lg-10 text-center" id='background-text'>
                        <h1 class="section-title text-gradient header-underline">Deployment</h1> <br>
                        <p> This section aims to describe the process of deploying this project to the Azure cloud as 
                            a Docker container, as well as how to automate the process. The benefit of automating this
                            procedure not only saves time but allows constant feedback from the client as soon as
                            any changes are implemented. </br></br>

                            Automating deployment is not an essential part of deploying the project, 
                            but it will save a lot of time having to manually update the builds on the cloud
                            service you decide to use, and to then reinstate the running project to the updated builds
                        </p>
                        <h4 class="section-title text-gradient header-underline">Pre Requisites</h4><br>
                        <p>
                            <strong> 1. An Existing Project
                            </strong><br>
                            The Django files for the project must have existed prior to deployment, with the bare minimum 
                            of being able to run <code>python manage.py runserver</code> without it erroring. Of course you 
                            could <i>try</i> to dockerise and deploy a non functional codebase, but why would you?
                        </p>
                        <p>
                            <strong> 2. Git (and access to the repository)
                            </strong><br>
                            You may install git <a href="https://git-scm.com/downloads">here</a>. You will need git installed 
                            on the system for version control.
                            <br><br>
                            You also need a GitHub account, you can create an account from 
                            <a href="https://github.com/">GitHub</a>.  
                            You require access to the respository so that you have push/pull rights to the codebase, 
                            which is a GitHub repository.

                        </p>
                        <p>
                            <strong> 3. Azure CLI
                            </strong><br>
                            You will need the Azure Cloud Shell or some installation of the Azure CLI to complete some of 
                            the steps necessary for <i> automated deployment</i>. You can install Azure CLI 
                            <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">from here</a>
                        </p>
                        <p>
                            <strong> 4. Azure Container Registry
                            </strong><br>
                            You need this registry to contain your Docker image. It will hold your Docker image in the 
                            Azure cloud, as well as all previous builds. It acts like a repository for Docker images!
                            <br><br>
                            You can create one using <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-portal">
                            this</a> guide. Remember what resource group is used for deployment as this is used when 
                            you automate the deployment using GitHub workflows. 
                        </p>
                        <p>
                            <strong> 5. Docker
                            </strong><br>
                            You need docker to build an image from your codebase, you can install it 
                            <a href="https://docs.docker.com/get-docker/"> here</a>
                        </p>
                        <br>
                        <h4 class="section-title text-gradient header-underline">Notice</h4><br>
                        <p>
                            <strong> Keep in mind
                            </strong><br>
                            You will need to ensure that 'Actions' is enabled for your repository.
                            You can make sure this is the case by going to <strong>Settings</strong> 
                            > <strong>Actions</strong> > <strong>Actions permissions</strong>, and select 
                            <strong>'Allow all actions'</strong>
                        </p>
                    </div>
                </div>
            </div>
        </section>
        <!-- End of Deployment-Intro section -->

        <!-- Start of Dockerizing section -->
        <section class="Dockerizing">
            <div class="container px-4 px-lg-5">
                <div class="row justify-content-center">
                    <div class="col-lg-10 text-center" id='background-text'>
                        <h1 class="section-title text-gradient header-underline">Dockerizing</h1> <br>
                        <p> Turning the project into a Docker image is not an essential part of the 
                            project, but it does offer a level of safety and encapsulation from the 
                            base system. This eliminates the cursed <i>"it works on my machine" </i>
                            fallacy.</br></br>

                            The Docker container will provide its own environment for the project to
                            run inside without the overhead of a virtual machine. <br><br>

                            This only serves as a <i>very</i> brief description of Docker. There 
                            are countless reasons for using Docker in the deployment of this 
                            project and you can read more about them <a href="https://www.docker.com/why-docker/">
                            here
                            </a>.
                        </p><br>
                        <h4 class="section-title text-gradient header-underline">Setting up Docker</h4><br>
                        <p>
                            <strong>Setup
                            </strong><br>
                            Before being able to create a Docker container for your project, 
                            you will need to have Docker installed locally. </br></br>

                            Please choose the correct installation guide for your machine from
                            <a href="https://docs.docker.com/get-docker/"> here</a>.
                        </p><br>
                        <h4 class="section-title text-gradient header-underline">Making the Dockerfile</h4><br>
                        <p>
                            <strong>Here's the Dockerfile
                            </strong><br>
                            Here's the Dockerfile that you can use to setup the container... </br></br>

                            Docker will use this file as guidance on how to build a container for our 
                            project. We need to place it at the root of the project directory, with the 
                            name <code>Dockerfile</code>. <br><br>
                            <samp>ucl-ixn-team19/</samp><br>
                            <samp class="indent-4">.gitignore</samp><br>
                            <code class="indent-4">Dockerfile</code><br>
                            <samp class="indent-4">README.md</samp><br>
                            <samp class="indent-4">requirements.txt</samp><br>
                            <samp class="indent-4">myvenv/</samp><br>
                            <samp class="indent-8">manage.py</samp><br>
                            <samp class="indent-8">lib/..</samp><br>
                            <samp class="indent-8">bin/..</samp><br>
                            <samp class="indent-8">mysite/</samp><br>
                            <samp class="indent-12">__init__.py</samp><br>
                            <samp class="indent-12">settings.py</samp><br>
                            <samp class="indent-12">urls.py</samp><br>
                            <samp class="indent-12">wsgi.py</samp><br>
                            <samp class="indent-8">website/</samp><br>
                            <samp class="indent-12">__init__.py</samp><br>
                            <samp class="indent-12">admin.py</samp><br>
                            <samp class="indent-12">apps.py</samp><br>
                            <samp class="indent-12">constants.py</samp><br>
                            <samp class="indent-12">forms.py</samp><br>
                            <samp class="indent-12">template_filter.py</samp><br>
                            <samp class="indent-12">urls.py</samp><br>
                            <samp class="indent-12">migrations/..</samp><br>
                            <samp class="indent-12">templates/..</samp><br>
                            <samp class="indent-12">tests/..</samp><br>

                        </p>
                        <p>
                            <strong>Contents of the Dockerfile:
                            </strong><br>

                            <samp><code>FROM</code> python:3.8.3-alpine</samp><br><br>
                                <samp># set work directory<samp><br>
                                
                                <samp><code>WORKDIR</code> /usr/src/app</samp><br><br>
                                
                                <samp># set environment variables</samp><br>
                                <samp><code>ENV</code> PYTHONDONTWRITEBYTECODE 1</samp><br>
                                <samp><code>ENV</code> PYTHONUNBUFFERED 1</samp><br><br>
                                
                                <samp># copy project</samp><br>
                                <samp><code>COPY</code> . /usr/src/app</samp><br><br>
                                
                                <samp># install dependencies</samp><br>
                                <samp><code>RUN</code> python -m pip install -r requirements.txt</samp><br>
                                
                                <samp><code>EXPOSE</code> 8000</samp><br><br>

                                <samp># commands issued to container</samp><br>

                                <samp><code>RUN</code> python myvenv/manage.py clearsessions</samp><br>
                                <samp><code>RUN</code> python myvenv/manage.py makemigrations</samp><br>
                                <samp><code>RUN</code> python myvenv/manage.py migrate</samp><br>
                                <samp><code>CMD</code> ["python", "myvenv/manage.py", "runserver", "0.0.0.0:8000"]</samp><br>
                        </p>
                        <p>
                            <strong>What does any of this mean?...
                            </strong><br>
                            Each of the lines in the <code>Dockerfile</code> is called a directive <br><br>

                            <samp><code>FROM</code> python:3.8.3-alpine </samp>
                            tells Docker which base image to build our container on. <br><br>

                            <samp><code>WORKDIR</code> /usr/src/app </samp>
                            sets the working directory, and all following directives are executed here.<br><br>
                            
                            <samp><code>ENV</code> PYTHONUNBUFFERED 1</samp> will
                            tell Docker to send Python output to the terminal instead of buffering it
                            in the standard output buffer app<br><br>

                            <samp><code>RUN</code> python -m pip install -r requirements.txt</samp>
                            installs all dependencies from <samp>requirements.txt</samp><br><br>

                            <strong>Further...</strong><br>
                            <samp><code>RUN</code> python myvenv/manage.py clearsessions</samp><br>
                            <samp><code>RUN</code> python myvenv/manage.py makemigrations</samp><br>
                            <samp><code>RUN</code> python myvenv/manage.py migrate</samp><br><br>
                            Are all run in order to prepare the Django project to be used and prevent 
                            any errors due to changes in the codebase 
                        </p>

                        <h4 class="section-title text-gradient header-underline">Running the project as a container</h4><br>
                        <p>
                            <strong>Building the Docker image
                            </strong><br>
                            Use this command, <i>from the root of the project directory</i>, in order to build an
                             image from the project files<br><br>
                            <samp><code>docker</code> build . -t &lt;image-name&gt;:latest</samp><br>
                            See documentation <a href="https://docs.docker.com/engine/reference/commandline/build/">
                            here</a>, remember to replace <code>&lt;image-name&gt;</code><br><br>

                            <code>-t</code> sets the tag for the image to <samp>latest</samp><br><br>
                        </p>
                        <p>
                            <strong>Running the Docker image
                            </strong><br>
                            Use this command in order to run a container based on the image we created<br><br>
                            <samp><code>docker</code> run --name &lt;image-name&gt; -d -p 8000:8000 &lt;image-name&gt;:latest
                            </samp><br>
                            See documentation <a href="https://docs.docker.com/engine/reference/commandline/run/">
                            here</a>
                            <br><br>

                            <code>-name</code> selects the name of the Docker container<br>
                            <code>-d</code> makes the image run in detached mode, i.e. the background<br>
                            <code>-p 8000:8000</code> maps port 8000 from the container to port 8000 of 
                            <samp>localhost</samp><br><br>

                            Now go to <samp>localhost:8000</samp> in your browser where the application
                            is running!<br><br>
                        </p>

                        <p>
                            <strong>Congratulations!!</strong><br>
                            You have sucessfully set configured the application to run its own isolated 
                            Docker container! 
                        </p>

                        <p>
                            <strong>Killing the container
                            </strong><br>
                            In order to pause the application, <i>remember that it was running
                            in the background</i>, we issue the following command.<br><br>


                            <samp><code>docker</code> ps</samp><br>
                            In order to list all running containers, see documentation 
                            <a href="https://docs.docker.com/engine/reference/commandline/ps/"> here</a>.<br><br>
                            
                            This would produce something like...<br>
                            <pre><samp>CONTAINER ID   IMAGE            COMMAND                  CREATED         STATUS         PORTS                    NAMES<br>841d06f865bc   testing:latest   "python myvenv/manag…"   9 minutes ago   Up 9 minutes   0.0.0.0:8000->8000/tcp   testing
                            </samp></pre>
                            
                        </p>
                        <p>
                            Remember to select the <samp>CONTAINER ID</samp>, in this case <code>841d06f865bc</code>. <br><br>

                            And then issue:<br>
                            <samp><code>docker</code> kill &lt;container-id&gt; </samp><br>
                            In order to stop <i>that</i> running container, see documentation 
                            <a href="https://docs.docker.com/engine/reference/commandline/kill/"> here</a>.<br>
                        </p>
                        
                    </div>
                </div>
            </div>
        </section>
        <!-- End of Dockerizing section -->
        <!-- Start of Deployment-Azure section -->
        <section class="Deployment-Azure">
            <div class="container px-4 px-lg-5">
                <div class="row justify-content-center">
                    <div class="col-lg-10 text-center" id='background-text'>
                        <h1 class="section-title text-gradient header-underline">Deploying to Azure</h1> <br>
                        <p>
                            This guide will describe the process of deploying the application
                            to Azure using github actions. We have chosen to deploy the application
                            to Azure, however a Docker container is portable and may be run at 
                            any endpoint! <i>So feel free to deploy anywhere you see fit!</i><br><br>
                            
                            Likewise keep in mind that we have already looked at how to run the 
                            project as a container locally, so there is nothing to stop you form
                            running it on premises!<br><br>
                        </p>

                        <h4 class="section-title text-gradient header-underline">Notice</h4><br>
                        <p>
                            <strong> Keep in mind
                            </strong><br>
                            You will have to adjust the endpoint permissions for the application...<br><br>

                            This involves adjusting the allowed hosts in <samp>myvenv/mysite/settings.py</samp>
                            and also changing the final directive in the <samp>Dockerfile</samp><br><br>

                            <strong> <samp>settings.py</samp>    
                            </strong><br>

                            <samp>
                                ALLOWED_HOSTS = ['127.0.0.1', 'localhost']<br><br>
                            </samp>
                            Would become<br>
                            <samp>
                                ALLOWED_HOSTS = ['127.0.0.1', 'localhost', <i>'your-endpoint-ip'</i>]
                            </samp><br><br>
                            
                            <strong> <samp>Dockerfile</samp>    
                            </strong><br>

                            <samp>...<br><code>CMD</code> ["python", "myvenv/manage.py", "runserver", "0.0.0.0:8000"]</samp><br><br>

                            Would change to<br>
                            <samp>...<br><code>CMD</code> ["python", "myvenv/manage.py", "runserver", <i>"your-endpoint-ip:port"</i>]</samp><br><br>

                            With this, you now have the potential to deploy your application <strong>anywhere</strong>!<br><br>

                            <strong>Likewise, if you choose to deploy the project to Azure, you will need to add the 
                            public IP address of the container instance to the allowed hosts</strong><br>
                        </p>

                        <h4 class="section-title text-gradient header-underline">Automating the deployment</h4><br>
                        <p>
                            <strong> Updating Dockerfile
                            </strong><br>
                            
                            We need to make a small change to our <code>Dockerfile</code><br><br>
                            <strong> <samp>Dockerfile</samp>    
                            </strong><br>

                            <samp>...<br><code>CMD</code> ["python", "myvenv/manage.py", "runserver", "0.0.0.0:8000"]</samp><br><br>

                            Would change to<br>
                            <samp>...<br><code>CMD</code> ["python", "myvenv/manage.py", "runserver", <i>"0.0.0.0:80"</i>]</samp><br><br>

                            I.e our final <code>Dockerfile</code> is:<br>
                            <samp><code>FROM</code> python:3.8.3-alpine</samp><br><br>
                            <samp># set work directory<samp><br>
                            
                            <samp><code>WORKDIR</code> /usr/src/app</samp><br><br>
                            
                            <samp># set environment variables</samp><br>
                            <samp><code>ENV</code> PYTHONDONTWRITEBYTECODE 1</samp><br>
                            <samp><code>ENV</code> PYTHONUNBUFFERED 1</samp><br><br>
                            
                            <samp># copy project</samp><br>
                            <samp><code>COPY</code> . /usr/src/app</samp><br><br>
                            
                            <samp># install dependencies</samp><br>
                            <samp><code>RUN</code> python -m pip install -r requirements.txt</samp><br>
                            
                            <samp><code>EXPOSE</code> 8000</samp><br><br>

                            <samp># commands issued to container</samp><br>

                            <samp><code>RUN</code> python myvenv/manage.py clearsessions</samp><br>
                            <samp><code>RUN</code> python myvenv/manage.py makemigrations</samp><br>
                            <samp><code>RUN</code> python myvenv/manage.py migrate</samp><br>
                            <samp><code>CMD</code> ["python", "myvenv/manage.py", "runserver", "0.0.0.0:80"]</samp><br>
                        </p>
                        <p>
                            <strong> Credentials for the GitHub repo
                            </strong><br>
                            
                            We need the following credentials noted down somewhere in order for our deployment to work:<br>
                        </p>
                        <p>
                            1. <samp>AZURE_CREDENTIALS</samp><br>
                            2. <samp>REGISTRY_LOGIN_SERVER</samp><br>
                            3. <samp>REGISTRY_USERNAME	</samp><br>
                            4. <samp>REGISTRY_PASSWORD</samp><br>
                            5. <samp>RESOURCE_GROUP</samp><br><br>

                            We will add them to our repository <i>secrets</i>.<br><br>

                        </p>
                        <p>
                            Keep in mind that our method of authenticating access to our Azure resources is through
                            a <i>service principal</i> which is stored as a secret in our GitHub repository.
                            It is documented <a href="https://docs.microsoft.com/en-us/azure/developer/github/connect-from-azure?tabs=azure-portal%2Cwindows#use-the-azure-login-action-with-a-service-principal-secret">here</a>.
                        </p>
                        <p>
                            <strong> Collecting credentials
                            </strong><br>
                            
                            Using the Azure CLI, we will create a <i>service principal</i> to authenticate Azure actions<br>
                        </p>
                        <p>
                            1. Get the <samp>GROUP_ID</samp> of the resource group using the name of the group<br>
                            <samp><code>az</code> group show --name &lt;resource-group-name&gt; --query id --output tsv
                            </samp><br>
                            We <strong>do not</strong> need to save the output of  this in github actions, however it is needed 
                            for the following steps so it is wise to keep it safe. 
                        </p>
                        <p>
                            2. Create the service principal using the <samp>GROUP_ID</samp> from the previous step<br>  
                            <samp><code>az</code> ad sp create-for-rbac --scope &lt;GROUP_ID&gt; --role Contributor --sdk-auth
                            </samp><br>
                            Which will result in  a JSON output similiar to: <br><br>
                            <samp>
                                {<br>
                                    <code>"clientId"</code>: "xxxx6ddc-xxxx-xxxx-xxx-ef78a99dxxxx",<br>
                                    <code>"clientSecret"</code>: "xxxx79dc-xxxx-xxxx-xxxx-aaaaaec5xxxx",<br>
                                    <code>"subscriptionId"</code>: "xxxx251c-xxxx-xxxx-xxxx-bf99a306xxxx",<br>
                                    <code>"tenantId"</code>: "xxxx88bf-xxxx-xxxx-xxxx-2d7cd011xxxx",<br>
                                    <code>"activeDirectoryEndpointUrl"</code>: "https://login.microsoftonline.com",<br>
                                    <code>"resourceManagerEndpointUrl"</code>: "https://management.azure.com/",<br>
                                    <code>"activeDirectoryGraphResourceId"</code>: "https://graph.windows.net/",<br>
                                    <code>"sqlManagementEndpointUrl"</code>: "https://management.core.windows.net:8443/",<br>
                                    <code>"galleryEndpointUrl"</code>: "https://gallery.azure.com/",<br>
                                    <code>"managementEndpointUrl"</code>: "https://management.core.windows.net/"<br>
                                  }
                            </samp><br><br>
                            
                            We need to save <strong>all</strong> of this JSON output for the later steps.<br>
                            We also need to note down the <code>clientId</code> which we need in the upcoming steps<br>
                        </p>
                        <p>
                            3. Get the <samp>REGISTRY_ID</samp> for the container registry by querying the registry name<br>
                            <samp><code>az</code> acr show --name &lt;registry-name&gt; --query id --output tsv
                            </samp><br>
                            We <strong>do not</strong> need to save the output of  this in github actions, however it is needed 
                            for the following steps so it is wise to keep it safe. Keep in mind this step assumes <i>you already
                            set up</i> a container registry as per the pre requisites.<br>
                        </p>
                        <p>
                            4. Assign the AcrPush role for the container registry using <samp>REGISTRY_ID</samp> and
                            <code>clientId</code> from the JSON output<br>  
                            <samp><code>az</code> role assignment create --assignee &lt;ClientId&gt; --scope &lt;registryId&gt; --role AcrPush
                            </samp><br>
                        </p>
                        <p>
                            <strong> Storing credentials
                            </strong><br>
                            
                            Using the Azure CLI, we have collected all the information needed for the automation to work!<br><br>
                            
                            We can save these credentials in GitHub secrets by selecting <strong>Settings</strong> 
                            > <strong>Secrets</strong> > <strong>Actions</strong>, and choosing 
                            <strong>'New Repository Secret'</strong><br><br>

                            We can now populate our GitHub repository secrets as such:
                            <table class="table text-left table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Secret</th>
                                        <th scope="col">Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <th scope="rol">AZURE_CREDENTIALS</th>
                                        <td>The entire JSON output from when we create service principal</td>
                                    </tr>
                                    <tr>
                                        <th scope="rol">REGISTRY_LOGIN_SERVER</th>
                                        <td>The name of the login server for the registry,<i> in lowercase</i><br>
                                        Such as: <i>moorfieldsapp.azurecr.io</i></td>
                                    </tr>
                                    <tr>
                                        <th scope="rol">REGISTRY_USERNAME</th>
                                        <td>The <code>clientId</code> from the JSON output</td>
                                    </tr>
                                    <tr>
                                        <th scope="rol">REGISTRY_PASSWORD</th>
                                        <td>The <code>clientSecret</code> from the JSON output</td>
                                    </tr>
                                    <tr>
                                        <th scope="rol">RESOURCE_GROUP</th>
                                        <td>The name of the resource group that we used to create the service principal</td>
                                    </tr>
                                </tbody>
                            </table>

                            And with this, our preparations are done! We've managed to do the tricky bit!<br>
                        </p>
                        <p>
                            <strong> Creating the workflow
                            </strong><br>

                            Now that our secrets are in place, we just need to automate the building and deploying of 
                            our project to our container registry using a GitHub <i>action</i>.<br><br>

                            1. Select <strong>Actions</strong> from the UI in your GitHub repository<br>
                            2. Select <strong>set up a workflow yourself</strong> from the menu<br>
                            3. Select a name for your workflow, or leave it as the default <samp>main.yml</samp> <br>
                            4. Paste the following YAML contents over the sample code<br>
                            5. Select <strong>Start commit</strong> to push your workflow to the repository<br>
                        </p> 
                        <p>
                            Here is the YAML file to paste in, <strong>remember</strong> that you need to
                            replace <i>&lt;image-name&gt;</i> with the name for your image
                            <pre class="text-left"><code class="language-yaml">
                                name: Automatic_Deployment
                                on:
                                  push:
                                    branches:
                                    - main
                                jobs:
                                    build-and-deploy:
                                        runs-on: ubuntu-latest
                                        steps:
                                        # checkout the repo
                                        - name: 'Checkout GitHub Action'
                                          uses: actions/checkout@main
                                          
                                        - name: 'Login via Azure CLI'
                                          uses: azure/login@v1
                                          with:
                                            creds: ${{ secrets.AZURE_CREDENTIALS }}
                                        
                                        - name: 'Build and push image'
                                          uses: azure/docker-login@v1
                                          with:
                                            login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
                                            username: ${{ secrets.REGISTRY_USERNAME }}
                                            password: ${{ secrets.REGISTRY_PASSWORD }}
                                        - run: |
                                            docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/&lt;image-name&gt;:latest
                                            docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/&lt;image-name&gt;:latest
                                
                                        - name: 'Deploy to Azure Container Instances'
                                          uses: 'azure/aci-deploy@v1'
                                          with:
                                            resource-group: ${{ secrets.RESOURCE_GROUP }}
                                            dns-name-label: ${{ secrets.RESOURCE_GROUP }}${{ github.run_number }}
                                            image: ${{ secrets.REGISTRY_LOGIN_SERVER }}/&lt;image-name&gt;:latest
                                            registry-login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
                                            registry-username: ${{ secrets.REGISTRY_USERNAME }}
                                            registry-password: ${{ secrets.REGISTRY_PASSWORD }}
                                            name: &lt;image-name&gt;
                                            location: 'uksouth'
                            </code>
                            </pre><br>

                            Keep in mind that this automation is triggered when pushing to <i>main</i>, 
                            feel free to change this to something else, such as <i>production</i> if needed! 
                        </p>   
                        <h4 class="section-title text-gradient header-underline">Finishing up</h4><br>

                        <p>
                            With this, our automatic deployment is set up!<br><br>

                            1. Navigate to your <strong>Azure portal</strong> over <a href="https://portal.azure.com/#home">
                                here</a>.<br>
                            2. Click on your container instance, recall that you changed <i>&lt;image-name&gt;</i>,
                            so that is what your container instance will be called! <br>
                            3. This will open up the dashboard for your container instance! Here you can see its <strong>
                                public IP adresss</strong>, this is where the project is deployed to!<br><br>

                            And thats it! You've gone ahead and automated the project to be built using Docker
                            and uploaded to the Azure cloud automatically!
                        </p>
                        <h4 class="section-title text-gradient header-underline">Some notes</h4><br>
                        <p>
                            <samp> 
                                <code>
                                    docker 
                                </code>
                                push ${{ secrets.REGISTRY_LOGIN_SERVER }}/&lt;image-name&gt;:latest
                            </samp><br>
                            
                            Pushes the freshly built Docker image to <strong>container registry</strong> from where 
                            the <i>latest</i> image replaces the running container instance!<br><br>

                            This is how it keeps the application at the endpoint, namely the public IP address of the 
                            container instance, up to date with the latest changes! Here is our deployment endpoint: 
                            <a href="http://20.108.118.162">20.108.118.162</a> 
                            though this assumes we still have Azure credits in our student accounts<br><br>

                            Further, this is how <strong>we</strong> chose to deploy our project... <i>
                                You can deploy this project anywhere since it is wrapped up as Docker container
                                that can be run anywhere!
                            </i> The possibilities are endless.<br>
                        </p>
                    </div>
                </div>
            </div>
        </section>
        <!-- End of Deployment-Azure section -->
    </main>
    <!-- Footer-->
    <footer class="border-top">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <ul class="list-inline text-center">
                        <li class="list-inline-item">
                            <a href="https://uclixnteam19.wordpress.com">
                                <span class="fa-stack fa-lg">
                                    <i class="fas fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-wordpress fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://www.facebook.com/UCLCS.Home/">
                                <span class="fa-stack fa-lg">
                                    <i class="fas fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://github.com/ArslanAftab/ucl-ixn-team19">
                                <span class="fa-stack fa-lg">
                                    <i class="fas fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <div class="small text-center text-muted fst-italic">
                        <p>Copyright © 2021 - 2022
                            <a href="https://www.moorfields.nhs.uk/">Moorfields Hospital</a>
                            ,
                            <a href="https://www.arslemon.com">Arslan Aftab</a>
                            ,
                            <a href="!#">Yue He</a>
                            ,
                            <a href="https://www.linkedin.com/in/kamil-ebanks/">Kamil Ebanks</a>
                            - All rights reserved.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
    <!-- * *                               SB Forms JS                               * *-->
    <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
    <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
    <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
</body>

</html>